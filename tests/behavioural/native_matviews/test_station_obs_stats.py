from datetime import datetime

import pytest
import sqlalchemy
from pycds.orm.native_matviews import StationObservationStats


@pytest.mark.usefixtures("new_db_left")
def test_vars_content(sesh_with_large_data):
    """Test that StationObservationStats definition is correct."""

    q = sesh_with_large_data.query(StationObservationStats)

    # No content before matview is refreshed
    assert q.count() == 0

    # Refresh
    sesh_with_large_data.execute(StationObservationStats.refresh())

    # Et voila
    assert q.count() > 0

    # Test that some expected rows are present.
    # This test sucks, relying as it does on hardcoded magic numbers taken from
    # the large dataset, and further tweaked from there (see below). But it's what
    # we've got just now.

    def ptime(s):
        return datetime.strptime(s, "%Y-%m-%d %H:%M:%S")
    expected_rows = {
        (
            ptime(min_obs_time),
            ptime(max_obs_time),
            station_id,
            history_id,
        )
        for min_obs_time, max_obs_time, station_id, history_id in (
            # The data previously inserted into the *table* that was maintained as a
            # fake matview was as follows. All station and history id pairs are correct,
            # but the min and max obs times differ slightly. The data used below are
            # extracted from the test database on the faith that they represent the
            # actual data there and that the query is correct. This is at best kludgy
            # and at worst completely hopeless as a test, but apart from reproducing the
            # query here (which itself would be no better of a test), there's nothing to
            # do other than to inspect the database and precompute values manually. :(
            # ("1956-12-01 00:00:00", "2015-03-31 00:00:00", 713, 1116),
            # ("1996-12-31 14:00:00", "2015-09-23 23:00:00", 2673, 3416),
            # ("2011-04-01 00:00:00", "2015-09-23 23:00:00", 2873, 3616),
            # ("2012-09-16 06:00:00", "2012-09-16 06:00:00", 6628, 8516),
            # ("1972-06-19 00:00:00", "2000-12-31 23:59:59", 1113, 1516),
            # ("1980-10-29 00:00:00", "2000-12-31 23:59:59", 1413, 1816),
            # ("1973-06-04 00:00:00", "1975-10-01 00:00:00", 5833, 7516),
            # ("2012-05-15 06:00:00", "2012-05-15 06:00:00", 6626, 8416),
            # ("1969-05-04 00:00:00", "1971-01-29 00:00:00", 5036, 6716),
            # ("1974-05-16 00:00:00", "1976-05-06 00:00:00", 3737, 5416),
            # ("1990-07-25 00:00:00", "1990-10-30 00:00:00", 4137, 5816),
            # ("1972-01-27 00:00:00", "1972-06-15 00:00:00", 3538, 5216),
            # ("1989-07-24 00:00:00", "1991-03-15 00:00:00", 4836, 6516),
            # ("1989-09-13 00:00:00", "2000-09-30 23:59:59", 2113, 2516),
            # ("1989-03-31 00:00:00", "2000-09-30 23:59:59", 1613, 2016),
            # ("1974-08-12 00:00:00", "1977-11-14 00:00:00", 4037, 5716),
            # ("1967-05-28 00:00:00", "1977-12-12 00:00:00", 4237, 5916),
            # ("1968-01-01 00:00:00", "2004-10-31 00:00:00", 913, 1316),
            # ("1969-05-02 00:00:00", "1971-03-30 00:00:00", 5235, 6916),
            # ("1962-11-01 00:00:00", "2000-12-31 23:59:59", 813, 1216),
            # ("1967-05-30 00:00:00", "1980-09-16 00:00:00", 6033, 7716),
            # ("1973-05-31 00:00:00", "1975-10-23 00:00:00", 3638, 5316),
            # ("1991-04-01 00:00:00", "1992-09-30 00:00:00", 1013, 1416),
            # ("1974-06-30 00:00:00", "1977-04-29 00:00:00", 3937, 5616),
            # ("1975-06-09 00:00:00", "1975-12-11 00:00:00", 6532, 8216),
            # ("1962-05-01 00:00:00", "2006-03-31 00:00:00", 613, 1016),
            # ("1974-07-17 00:00:00", "2000-12-31 23:59:59", 113, 516),
            # ("1977-06-24 00:00:00", "1978-04-13 00:00:00", 4636, 6316),
            # ("1959-07-02 00:00:00", "1962-09-30 00:00:00", 13, 416),
            # ("1971-05-28 00:00:00", "1973-10-26 00:00:00", 5634, 7316),
            # ("1969-06-29 00:00:00", "1970-09-28 00:00:00", 4437, 6116),
            # ("1981-06-24 00:00:00", "1983-09-28 00:00:00", 6332, 8016),
            # ("1972-06-21 00:00:00", "2000-12-31 23:59:59", 1213, 1616),
            # ("1974-03-05 00:00:00", "2000-12-31 23:59:59", 413, 816),
            # ("1979-11-06 00:00:00", "2000-12-31 23:59:59", 1313, 1716),
            # ("1983-12-01 00:00:00", "1984-01-31 00:00:00", 313, 716),
            # ("1994-11-21 16:00:00", "2009-06-30 23:00:00", 2613, 3016),
            # ("1969-06-27 00:00:00", "1971-03-30 00:00:00", 5136, 6816),
            # ("2006-02-10 13:00:00", "2006-06-06 12:00:00", 2313, 2716),
            # ("2011-05-31 06:00:00", "2013-08-27 13:00:00", 6631, 8316),
            # ("2006-09-15 00:00:00", "2010-09-14 00:00:00", 1513, 1916),
            # ("1982-07-15 14:00:00", "1983-08-22 15:00:00", 4337, 6016),
            # ("1973-07-18 00:00:00", "1978-11-20 00:00:00", 3438, 5116),
            # ("1990-09-19 11:00:00", "2011-04-05 16:00:00", 2773, 3516),
            # ("1971-07-30 00:00:00", "1977-10-20 00:00:00", 6132, 7816),
            # ("1957-07-01 00:00:00", "1958-10-31 00:00:00", 513, 916),
            # ("1966-05-30 00:00:00", "1970-10-31 00:00:00", 5335, 7016),
            ("1959-07-02 00:00:00",  "1959-08-21 00:00:00",  13,  416),
            ("1974-07-17 00:00:00",  "2000-12-31 23:59:59",  113,  516),
            ("1983-12-01 00:00:00",  "1984-01-31 00:00:00",  313,  716),
            ("1974-03-06 00:00:00",  "2000-12-31 23:59:59",  413,  816),
            ("1957-10-01 00:00:00",  "1957-12-20 00:00:00",  513,  916),
            ("2000-01-31 23:59:59",  "2005-02-23 00:00:00",  613,  1016),
            ("2015-01-01 00:00:00",  "2015-03-31 00:00:00",  713,  1116),
            ("1985-09-01 00:00:00",  "2000-12-31 23:59:59",  813,  1216),
            ("1997-06-01 00:00:00",  "2000-12-31 23:59:59",  913,  1316),
            ("1991-04-01 00:00:00",  "1991-05-20 00:00:00",  1013,  1416),
            ("1972-06-19 00:00:00",  "2000-12-31 23:59:59",  1113,  1516),
            ("1972-06-21 00:00:00",  "2000-12-31 23:59:59",  1213,  1616),
            ("1979-11-06 00:00:00",  "2000-12-31 23:59:59",  1313,  1716),
            ("1980-10-29 00:00:00",  "2000-12-31 23:59:59",  1413,  1816),
            ("2006-09-15 00:00:00",  "2006-11-03 00:00:00",  1513,  1916),
            ("1989-03-31 00:00:00",  "2000-09-30 23:59:59",  1613,  2016),
            ("1989-09-13 00:00:00",  "2000-09-30 23:59:59",  2113,  2516),
            ("2006-02-10 13:00:00",  "2006-02-12 14:00:00",  2313,  2716),
            ("2004-08-27 14:00:00",  "2004-08-29 15:00:00",  2613,  3016),
            ("2015-09-24 10:00:00",  "2015-09-24 16:00:00",  2673,  3416),
            ("1990-12-21 12:00:00",  "2000-12-31 23:59:59",  2773,  3516),
            ("2015-09-09 03:00:00",  "2015-09-24 16:00:00",  2873,  3616),
            ("1973-08-17 00:00:00",  "1978-09-28 00:00:00",  3438,  5116),
            ("1972-01-28 00:00:00",  "1972-03-17 00:00:00",  3538,  5216),
            ("1973-05-31 00:00:00",  "1975-10-23 00:00:00",  3638,  5316),
            ("1974-05-17 00:00:00",  "1976-05-06 00:00:00",  3737,  5416),
            ("1974-06-30 00:00:00",  "1977-04-29 00:00:00",  3937,  5616),
            ("1974-08-28 00:00:00",  "1977-11-14 00:00:00",  4037,  5716),
            ("1990-07-25 00:00:00",  "1990-09-12 00:00:00",  4137,  5816),
            ("1969-05-28 00:00:00",  "1977-10-17 00:00:00",  4237,  5916),
            ("1982-07-15 14:00:00",  "1983-08-22 15:00:00",  4337,  6016),
            ("1969-06-29 00:00:00",  "1970-09-28 00:00:00",  4437,  6116),
            ("1977-06-24 00:00:00",  "1978-04-13 00:00:00",  4636,  6316),
            ("1989-07-24 00:00:00",  "1989-09-12 00:00:00",  4836,  6516),
            ("1969-05-04 00:00:00",  "1971-01-29 00:00:00",  5036,  6716),
            ("1969-06-27 00:00:00",  "1971-03-30 00:00:00",  5136,  6816),
            ("1969-05-02 00:00:00",  "1971-03-30 00:00:00",  5235,  6916),
            ("1966-05-30 00:00:00",  "1970-10-31 00:00:00",  5335,  7016),
            ("1971-05-28 00:00:00",  "1973-10-26 00:00:00",  5634,  7316),
            ("1973-06-04 00:00:00",  "1975-10-01 00:00:00",  5833,  7516),
            ("1976-07-20 00:00:00",  "1980-09-16 00:00:00",  6033,  7716),
            ("1971-07-30 00:00:00",  "1977-10-20 00:00:00",  6132,  7816),
            ("1981-06-24 00:00:00",  "1983-05-16 09:57:00",  6332,  8016),
            ("1975-06-10 00:00:00",  "1975-08-05 00:00:00",  6532,  8216),
            ("2013-08-22 04:00:00",  "2013-08-22 11:00:00",  6631,  8316),
            ("2012-05-15 06:00:00",  "2012-05-15 06:00:00",  6626,  8416),
            ("2012-09-16 06:00:00",  "2012-09-16 06:00:00",  6628,  8516),
        )
    }

    # Goofy column order, but the test data is in that order
    result_rows = {
        (
            row.min_obs_time,
            row.max_obs_time,
            row.station_id,
            row.history_id,
        )
        for row in q.all()
    }

    assert expected_rows <= result_rows


@pytest.mark.usefixtures("new_db_left")
def test_index(schema_name, prepared_schema_from_migrations_left):
    """Test that StationObservationStats has the expected index."""
    engine, script = prepared_schema_from_migrations_left
    inspector = sqlalchemy.inspect(engine)
    indexes = inspector.get_indexes(
        table_name=(StationObservationStats.base_name()), schema=schema_name
    )
    assert indexes == [
        {
            "name": "station_obs_stats_mv_idx",
            "column_names": [
                "min_obs_time",
                "max_obs_time",
                "obs_count",
                "station_id",
                "history_id",
            ],
            "unique": False,
            "include_columns": [],
            "dialect_options": {"postgresql_include": []},
        }
    ]
