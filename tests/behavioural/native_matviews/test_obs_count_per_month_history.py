from datetime import datetime

import pytest
import sqlalchemy
from pycds.database import get_schema_item_names
from pycds.orm.native_matviews import ObsCountPerMonthHistory


@pytest.mark.usefixtures("new_db_left")
def test_matview_content(sesh_with_large_data):
    """Test that ObsCountPerMonthHistory definition is correct."""

    q = sesh_with_large_data.query(ObsCountPerMonthHistory)

    # No content before matview is refreshed
    assert q.count() == 0

    # Refresh
    sesh_with_large_data.execute(ObsCountPerMonthHistory.refresh())

    # Et voila
    assert q.count() > 0

    # Test that some expected rows are present.
    # This test sucks, relying as it does on hardcoded magic numbers taken from
    # the large dataset. But it's what we've got just now, and at least it tests that
    # the old query and the new produce identical results.

    def ptime(s):
        return datetime.strptime(s, "%Y-%m-%d %H:%M:%S")

    expected_rows = {
        (
            count,
            ptime(month),
            history_id,
        )
        for count, month, history_id in (
            # The data previously inserted into the *table* that was maintained as a
            # fake matview is as follows.
            (2, "1976-08-01 00:00:00", 5716),
            (1, "1969-08-01 00:00:00", 6816),
            (4, "2000-09-01 00:00:00", 1616),
            (1, "1977-05-01 00:00:00", 5116),
            (1, "1973-07-01 00:00:00", 5316),
            (1, "1975-04-01 00:00:00", 5616),
            (1, "1974-10-01 00:00:00", 5916),
            (4, "2000-09-01 00:00:00", 1316),
            (1, "1969-08-01 00:00:00", 6916),
            (1, "1978-03-01 00:00:00", 6316),
            (4, "2000-02-01 00:00:00", 1016),
            (1, "1977-09-01 00:00:00", 5116),
            (3, "1969-10-01 00:00:00", 5916),
            (1, "1975-09-01 00:00:00", 5916),
            (2, "1982-09-01 00:00:00", 6016),
            (31, "1990-08-01 00:00:00", 5816),
            (2, "1972-06-01 00:00:00", 1616),
            (16, "2015-01-01 00:00:00", 1116),
            (1, "1969-09-01 00:00:00", 6916),
            (2, "1975-07-01 00:00:00", 5716),
            (2, "1974-06-01 00:00:00", 5616),
            (2, "1970-07-01 00:00:00", 6916),
            (1, "1970-05-01 00:00:00", 6716),
            (4, "2000-09-01 00:00:00", 1016),
            (1, "1980-04-01 00:00:00", 7716),
            (4, "2000-09-01 00:00:00", 1516),
            (2, "1982-10-01 00:00:00", 6016),
            (4, "2000-02-01 00:00:00", 1316),
            (1, "1970-02-01 00:00:00", 6816),
            (2, "1975-08-01 00:00:00", 7816),
            (1, "1970-06-01 00:00:00", 6816),
            (2, "1975-07-01 00:00:00", 5616),
            (1, "1976-04-01 00:00:00", 5416),
            (7, "1990-06-01 00:00:00", 2516),
            (1, "1975-06-01 00:00:00", 5916),
            (1, "1969-09-01 00:00:00", 6816),
            (1, "1970-07-01 00:00:00", 6816),
            (1, "1974-08-01 00:00:00", 5416),
            (2, "1973-08-01 00:00:00", 7316),
            (1, "1981-09-01 00:00:00", 8016),
            (2, "1978-10-01 00:00:00", 7716),
            (1, "1975-10-01 00:00:00", 5916),
            (1, "1970-02-01 00:00:00", 6916),
            (1, "1974-09-01 00:00:00", 5416),
            (2, "1970-06-01 00:00:00", 6916),
            (1, "1972-05-01 00:00:00", 5916),
            (3, "2000-02-01 00:00:00", 1816),
            (2, "1966-08-01 00:00:00", 7016),
            (2, "1977-07-01 00:00:00", 6316),
            (4, "2000-02-01 00:00:00", 1616),
            (2, "1975-12-01 00:00:00", 5416),
            (2, "1974-08-01 00:00:00", 5616),
            (1, "1970-04-01 00:00:00", 6916),
            (1, "1975-12-01 00:00:00", 5716),
            (2, "1977-09-01 00:00:00", 6316),
            (1, "1978-03-01 00:00:00", 5116),
            (1, "1978-01-01 00:00:00", 7716),
            (1, "1976-04-01 00:00:00", 5616),
            (4, "2000-08-01 00:00:00", 1516),
            (2, "1966-07-01 00:00:00", 7016),
            (1, "1975-09-01 00:00:00", 5116),
            (2, "1974-08-01 00:00:00", 5716),
            (4, "2000-08-01 00:00:00", 1016),
            (2, "1974-10-01 00:00:00", 5316),
            (1, "1975-12-01 00:00:00", 5616),
            (31, "1981-07-01 00:00:00", 8016),
            (1, "1970-01-01 00:00:00", 6816),
            (2, "1974-09-01 00:00:00", 5616),
            (3, "2000-03-01 00:00:00", 3516),
            (1, "1976-04-01 00:00:00", 5716),
            (2, "1974-10-01 00:00:00", 7516),
            (2, "1979-05-01 00:00:00", 7716),
            (2, "1969-07-01 00:00:00", 5916),
            (4, "2000-11-01 00:00:00", 1016),
            (11, "1974-06-01 00:00:00", 5416),
            (1, "1971-10-01 00:00:00", 5916),
            (1, "1977-12-01 00:00:00", 6316),
            (1, "1975-06-01 00:00:00", 5116),
            (1, "1970-01-01 00:00:00", 6916),
            (1, "1970-05-01 00:00:00", 6116),
            (1, "1975-07-01 00:00:00", 5416),
            (1, "1977-02-01 00:00:00", 5116),
            (1, "1972-07-01 00:00:00", 5916),
            (1, "1975-10-01 00:00:00", 5116),
            (2, "1971-07-01 00:00:00", 5916),
            (4, "1969-05-01 00:00:00", 6716),
            (4, "2000-11-01 00:00:00", 1516),
            (1, "1969-12-01 00:00:00", 6816),
            (1, "1974-07-01 00:00:00", 5416),
            (1, "1977-05-01 00:00:00", 5916),
            (1, "1977-07-01 00:00:00", 5116),
            (1, "1969-11-01 00:00:00", 6716),
            (4, "2000-11-01 00:00:00", 1316),
            (2, "1978-05-01 00:00:00", 5116),
            (1, "1976-12-01 00:00:00", 5616),
            (3, "1969-06-01 00:00:00", 7016),
            (21, "1975-06-01 00:00:00", 8216),
            (4, "2000-08-01 00:00:00", 1616),
            (1, "1975-06-01 00:00:00", 5316),
            (2, "1975-10-01 00:00:00", 7516),
            (30, "1991-04-01 00:00:00", 1416),
            (3, "2000-08-01 00:00:00", 1816),
            (2, "1978-06-01 00:00:00", 5116),
            (3, "2000-12-01 00:00:00", 3516),
            (1, "1975-10-01 00:00:00", 5316),
            (1, "1976-12-01 00:00:00", 7716),
            (1, "1970-09-01 00:00:00", 6116),
            (4, "2000-11-01 00:00:00", 1616),
            (1, "2000-06-01 00:00:00", 2016),
            (3, "2000-11-01 00:00:00", 1816),
            (1, "1969-12-01 00:00:00", 6916),
            (1, "1977-09-01 00:00:00", 5916),
            (29, "1972-02-01 00:00:00", 5216),
            (2, "1973-08-01 00:00:00", 7816),
            (2, "1975-09-01 00:00:00", 5316),
            (2, "2005-02-01 00:00:00", 1016),
            (2, "1975-04-01 00:00:00", 5416),
            (2, "1970-10-01 00:00:00", 6716),
            (3, "1971-11-01 00:00:00", 7316),
            (4, "2000-08-01 00:00:00", 1316),
            (2, "1975-09-01 00:00:00", 7516),
            (2, "1974-02-01 00:00:00", 5116),
            (1, "1972-10-01 00:00:00", 7816),
            (4, "2000-10-01 00:00:00", 1016),
            (2, "1977-10-01 00:00:00", 6316),
            (1, "1969-11-01 00:00:00", 6916),
            (1, "1975-08-01 00:00:00", 5716),
            (15, "1974-05-01 00:00:00", 5416),
            (2, "1975-01-01 00:00:00", 5416),
            (2, "1975-03-01 00:00:00", 5416),
            (2, "1970-10-01 00:00:00", 6816),
            (4, "2000-05-01 00:00:00", 1316),
            (4, "2000-10-01 00:00:00", 1516),
            (2, "1973-09-01 00:00:00", 5916),
            (1, "1975-07-01 00:00:00", 7816),
            (2, "1972-08-01 00:00:00", 7816),
            (4, "2012-05-01 00:00:00", 8416),
            (2, "1969-08-01 00:00:00", 6116),
            (1, "1973-05-01 00:00:00", 5916),
            (1, "1969-12-01 00:00:00", 6716),
            (1, "2000-09-01 00:00:00", 2016),
            (1, "1976-01-01 00:00:00", 5116),
            (2, "1969-07-01 00:00:00", 7016),
            (4, "2000-04-01 00:00:00", 1516),
            (1, "1975-05-01 00:00:00", 5116),
            (2, "1969-11-01 00:00:00", 6816),
            (2, "1971-06-01 00:00:00", 7316),
            (1, "2000-03-01 00:00:00", 516),
            (2, "1973-10-01 00:00:00", 7316),
            (2, "1970-08-01 00:00:00", 6116),
            (4, "2000-07-01 00:00:00", 816),
            (4, "2000-12-01 00:00:00", 1716),
            (1, "1972-04-01 00:00:00", 5916),
            (4, "2000-05-01 00:00:00", 1816),
            (4, "2000-04-01 00:00:00", 1016),
            (4, "2000-05-01 00:00:00", 1616),
            (2, "1970-10-01 00:00:00", 6916),
            (1, "1976-07-01 00:00:00", 5116),
            (3, "2000-10-01 00:00:00", 1816),
            (4, "2000-10-01 00:00:00", 1616),
            (1, "1970-03-01 00:00:00", 6816),
            (2, "1975-05-01 00:00:00", 7516),
            (2, "1977-08-01 00:00:00", 5716),
            (1, "1970-04-01 00:00:00", 6716),
            (2, "1973-06-01 00:00:00", 7316),
            (1, "1976-03-01 00:00:00", 5416),
            (2, "1977-08-01 00:00:00", 7716),
            (1, "1972-06-01 00:00:00", 7316),
            (2, "1971-08-01 00:00:00", 7316),
            (4, "2000-04-01 00:00:00", 1316),
            (1, "1977-04-01 00:00:00", 5116),
            (1, "1976-05-01 00:00:00", 5616),
            (4, "2000-05-01 00:00:00", 1516),
            (1, "1977-10-01 00:00:00", 5916),
            (20, "1957-12-01 00:00:00", 916),
            (4, "2000-07-01 00:00:00", 1216),
            (50, "2015-09-01 00:00:00", 3416),
            (1, "1977-03-01 00:00:00", 5116),
            (2, "1966-06-01 00:00:00", 7016),
            (1, "1970-03-01 00:00:00", 6916),
            (2, "1974-07-01 00:00:00", 7816),
            (4, "2000-10-01 00:00:00", 1316),
            (1, "2000-12-01 00:00:00", 516),
            (1, "1976-02-01 00:00:00", 5116),
            (29, "1990-12-01 00:00:00", 3516),
            (2, "1979-11-01 00:00:00", 1716),
            (4, "1969-05-01 00:00:00", 6916),
            (2, "1969-06-01 00:00:00", 5916),
            (4, "2000-04-01 00:00:00", 1616),
            (4, "2000-03-01 00:00:00", 1716),
            (1, "1970-01-01 00:00:00", 6716),
            (4, "2000-05-01 00:00:00", 1016),
            (3, "2000-04-01 00:00:00", 1816),
            (2, "1970-07-01 00:00:00", 6116),
            (2, "1969-09-01 00:00:00", 6116),
            (2, "1972-08-01 00:00:00", 7316),
            (2, "1969-09-01 00:00:00", 6716),
            (2, "1970-07-01 00:00:00", 6716),
            (2, "1970-05-01 00:00:00", 6916),
            (4, "2000-06-01 00:00:00", 1016),
            (18, "1989-09-01 00:00:00", 2516),
            (4, "2000-06-01 00:00:00", 1516),
            (1, "1976-07-01 00:00:00", 5916),
            (1, "1977-06-01 00:00:00", 6316),
            (2, "1980-08-01 00:00:00", 7716),
            (2, "1972-10-01 00:00:00", 7316),
            (4, "2000-03-01 00:00:00", 816),
            (1, "1976-03-01 00:00:00", 5616),
            (1, "1973-09-01 00:00:00", 7516),
            (1, "2000-07-01 00:00:00", 516),
            (1, "1973-09-01 00:00:00", 5316),
            (11, "1989-09-01 00:00:00", 6516),
            (1, "1973-05-01 00:00:00", 5316),
            (4, "2000-01-01 00:00:00", 1016),
            (4, "2000-01-01 00:00:00", 1516),
            (4, "2000-12-01 00:00:00", 1216),
            (2, "1976-03-01 00:00:00", 5716),
            (2, "1970-04-01 00:00:00", 6116),
            (1, "1976-05-01 00:00:00", 5416),
            (8, "1989-07-01 00:00:00", 6516),
            (1, "1978-02-01 00:00:00", 7716),
            (1, "1976-06-01 00:00:00", 5116),
            (1, "1970-02-01 00:00:00", 6716),
            (4, "1976-09-01 00:00:00", 5616),
            (31, "1984-01-01 00:00:00", 716),
            (2, "1974-08-01 00:00:00", 7816),
            (4, "2000-01-01 00:00:00", 1316),
            (2, "1970-09-01 00:00:00", 6816),
            (2, "1971-08-01 00:00:00", 7816),
            (1, "1973-09-01 00:00:00", 5116),
            (2, "1970-08-01 00:00:00", 6716),
            (4, "2000-06-01 00:00:00", 1616),
            (2, "1972-09-01 00:00:00", 5916),
            (11, "1980-11-01 00:00:00", 1816),
            (1, "1983-04-01 00:00:00", 8016),
            (2, "1976-09-01 00:00:00", 5716),
            (2, "1978-07-01 00:00:00", 7716),
            (4, "2000-12-01 00:00:00", 816),
            (2, "1969-08-01 00:00:00", 6716),
            (4, "2000-06-01 00:00:00", 1316),
            (1, "1975-03-01 00:00:00", 5716),
            (1, "1975-01-01 00:00:00", 5716),
            (4, "2000-01-01 00:00:00", 1816),
            (50, "2015-09-01 00:00:00", 3616),
            (4, "2000-07-01 00:00:00", 1716),
            (4, "2000-01-01 00:00:00", 1616),
            (2, "1970-09-01 00:00:00", 6916),
            (1, "1973-11-01 00:00:00", 5116),
            (4, "2000-03-01 00:00:00", 1216),
            (1, "1975-08-01 00:00:00", 5416),
            (1, "1978-04-01 00:00:00", 7716),
            (2, "1983-08-01 00:00:00", 6016),
            (1, "1975-01-01 00:00:00", 5616),
            (1, "1975-03-01 00:00:00", 5616),
            (2, "1969-10-01 00:00:00", 7016),
            (1, "1977-06-01 00:00:00", 5916),
            (1, "2000-08-01 00:00:00", 2016),
            (1, "1971-09-01 00:00:00", 5916),
            (1, "1976-11-01 00:00:00", 5116),
            (1, "1974-12-01 00:00:00", 5416),
            (1, "1975-08-01 00:00:00", 5916),
            (1, "1975-05-01 00:00:00", 5416),
            (2, "1983-07-01 00:00:00", 6016),
            (4, "2000-11-01 00:00:00", 1716),
            (2, "1976-09-01 00:00:00", 5116),
            (2, "1973-08-01 00:00:00", 7516),
            (31, "2015-03-01 00:00:00", 1116),
            (4, "2000-02-01 00:00:00", 1216),
            (1, "1981-11-01 00:00:00", 8016),
            (2, "1970-05-01 00:00:00", 7016),
            (1, "1976-11-01 00:00:00", 5716),
            (4, "1977-08-01 00:00:00", 6316),
            (1, "2000-07-01 00:00:00", 2016),
            (2, "1974-03-01 00:00:00", 816),
            (2, "1979-09-01 00:00:00", 7716),
            (50, "2013-08-01 00:00:00", 8316),
            (1, "1975-01-01 00:00:00", 5116),
            (1, "1974-05-01 00:00:00", 5116),
            (3, "1975-10-01 00:00:00", 7816),
            (2, "1969-08-01 00:00:00", 5916),
            (3, "2000-05-01 00:00:00", 3516),
            (4, "2000-08-01 00:00:00", 1716),
            (50, "2004-08-01 00:00:00", 3016),
            (1, "1971-11-01 00:00:00", 5916),
            (4, "2000-09-01 00:00:00", 816),
            (2, "1978-07-01 00:00:00", 5116),
            (2, "1975-06-01 00:00:00", 7816),
            (1, "1977-08-01 00:00:00", 5916),
            (1, "2000-11-01 00:00:00", 516),
            (1, "1976-05-01 00:00:00", 5916),
            (2, "1976-10-01 00:00:00", 5616),
            (1, "1970-09-01 00:00:00", 7016),
            (4, "2000-02-01 00:00:00", 816),
            (1, "1976-02-01 00:00:00", 5416),
            (4, "1972-01-01 00:00:00", 5216),
            (1, "1970-12-01 00:00:00", 6716),
            (12, "1990-09-01 00:00:00", 5816),
            (1, "1969-10-01 00:00:00", 6916),
            (15, "1974-07-01 00:00:00", 516),
            (1, "1969-06-01 00:00:00", 6116),
            (2, "1976-10-01 00:00:00", 5716),
            (2, "1985-09-01 00:00:00", 1216),
            (1, "1981-10-01 00:00:00", 8016),
            (2, "1976-06-01 00:00:00", 5716),
            (2, "1979-08-01 00:00:00", 7716),
            (2, "1972-01-01 00:00:00", 7316),
            (1, "1975-02-01 00:00:00", 5716),
            (2, "1977-10-01 00:00:00", 5716),
            (1, "1976-03-01 00:00:00", 5116),
            (2, "1977-10-01 00:00:00", 7716),
            (2, "1973-07-01 00:00:00", 7316),
            (1, "2000-08-01 00:00:00", 2516),
            (4, "2000-09-01 00:00:00", 1216),
            (1, "2000-08-01 00:00:00", 516),
            (1, "1969-10-01 00:00:00", 6816),
            (3, "2000-04-01 00:00:00", 3516),
            (1, "1975-02-01 00:00:00", 5616),
            (2, "1972-07-01 00:00:00", 7316),
            (2, "1971-07-01 00:00:00", 7316),
            (1, "1973-08-01 00:00:00", 5116),
            (4, "2000-11-01 00:00:00", 1216),
            (14, "1989-05-01 00:00:00", 2016),
            (1, "1969-07-01 00:00:00", 6916),
            (3, "1976-07-01 00:00:00", 5616),
            (1, "1970-11-01 00:00:00", 6716),
            (2, "1977-08-01 00:00:00", 5116),
            (4, "2000-02-01 00:00:00", 1716),
            (2, "1975-11-01 00:00:00", 5716),
            (1, "1976-05-01 00:00:00", 5116),
            (2, "1976-07-01 00:00:00", 5716),
            (1, "1976-07-01 00:00:00", 7716),
            (1, "1977-04-01 00:00:00", 5616),
            (1, "1978-04-01 00:00:00", 6316),
            (1, "1970-10-01 00:00:00", 7016),
            (1, "1977-03-01 00:00:00", 5616),
            (2, "1969-06-01 00:00:00", 6716),
            (4, "1975-08-01 00:00:00", 8216),
            (1, "1976-02-01 00:00:00", 5716),
            (1, "2000-09-01 00:00:00", 516),
            (2, "1980-07-01 00:00:00", 7716),
            (1, "1973-08-01 00:00:00", 5916),
            (1, "1969-07-01 00:00:00", 6816),
            (1, "2000-09-01 00:00:00", 2516),
            (2, "1972-05-01 00:00:00", 7316),
            (1, "1983-05-01 00:00:00", 8016),
            (4, "2000-08-01 00:00:00", 1216),
            (1, "1978-08-01 00:00:00", 7716),
            (1, "1982-07-01 00:00:00", 6016),
            (1, "1975-08-01 00:00:00", 5316),
            (1, "1977-03-01 00:00:00", 7716),
            (1, "1976-02-01 00:00:00", 5616),
            (2, "1997-06-01 00:00:00", 1316),
            (1, "1971-01-01 00:00:00", 6716),
            (30, "1989-04-01 00:00:00", 2016),
            (31, "2006-10-01 00:00:00", 1916),
            (4, "2000-11-01 00:00:00", 816),
            (2, "1969-05-01 00:00:00", 7016),
            (1, "1975-08-01 00:00:00", 5116),
            (1, "1978-02-01 00:00:00", 6316),
            (1, "2000-02-01 00:00:00", 516),
            (4, "2000-08-01 00:00:00", 816),
            (2, "1971-07-01 00:00:00", 7816),
            (29, "1959-07-01 00:00:00", 416),
            (17, "1972-03-01 00:00:00", 5216),
            (2, "1972-07-01 00:00:00", 7816),
            (3, "2000-01-01 00:00:00", 3516),
            (4, "2000-09-01 00:00:00", 1716),
            (1, "1974-12-01 00:00:00", 5616),
            (1, "1976-01-01 00:00:00", 5616),
            (23, "1974-08-01 00:00:00", 516),
            (2, "1977-06-01 00:00:00", 5716),
            (1, "1973-07-01 00:00:00", 7816),
            (1, "1971-10-01 00:00:00", 7816),
            (1, "1976-01-01 00:00:00", 5716),
            (1, "1974-12-01 00:00:00", 5716),
            (2, "1975-05-01 00:00:00", 5716),
            (2, "1980-05-01 00:00:00", 7716),
            (2, "1974-03-01 00:00:00", 5116),
            (4, "2000-07-01 00:00:00", 1816),
            (1, "1976-12-01 00:00:00", 5116),
            (1, "1978-06-01 00:00:00", 7716),
            (4, "2000-07-01 00:00:00", 1616),
            (4, "2000-01-01 00:00:00", 1716),
            (1, "1977-01-01 00:00:00", 7716),
            (2, "1971-01-01 00:00:00", 6916),
            (1, "1983-01-01 00:00:00", 8016),
            (4, "2000-05-01 00:00:00", 816),
            (2, "1977-01-01 00:00:00", 5716),
            (1, "1971-03-01 00:00:00", 6916),
            (2, "1972-09-01 00:00:00", 7316),
            (1, "1978-05-01 00:00:00", 7716),
            (2, "1980-09-01 00:00:00", 7716),
            (4, "2000-04-01 00:00:00", 1216),
            (2, "1977-07-01 00:00:00", 5716),
            (1, "1977-01-01 00:00:00", 5616),
            (1, "1977-07-01 00:00:00", 7716),
            (2, "1971-01-01 00:00:00", 6816),
            (4, "2000-06-01 00:00:00", 1716),
            (2, "1974-08-01 00:00:00", 7516),
            (1, "1973-10-01 00:00:00", 5116),
            (2, "1971-05-01 00:00:00", 7316),
            (4, "2000-10-01 00:00:00", 1216),
            (1, "1974-10-01 00:00:00", 5716),
            (4, "2000-07-01 00:00:00", 1316),
            (3, "1980-10-01 00:00:00", 1816),
            (3, "2012-09-01 00:00:00", 8516),
            (2, "1974-07-01 00:00:00", 5916),
            (2, "1973-06-01 00:00:00", 7516),
            (2, "1974-01-01 00:00:00", 5116),
            (1, "1974-11-01 00:00:00", 5416),
            (2, "1971-09-01 00:00:00", 7316),
            (1, "1971-03-01 00:00:00", 6816),
            (1, "1973-06-01 00:00:00", 5316),
            (2, "1977-10-01 00:00:00", 7816),
            (2, "1974-09-01 00:00:00", 7516),
            (1, "1976-04-01 00:00:00", 5116),
            (4, "2000-07-01 00:00:00", 1016),
            (1, "1972-08-01 00:00:00", 5916),
            (1, "1969-06-01 00:00:00", 6816),
            (1, "1975-07-01 00:00:00", 5916),
            (1, "1973-10-01 00:00:00", 5316),
            (50, "2006-02-01 00:00:00", 2716),
            (4, "2000-04-01 00:00:00", 816),
            (2, "1969-07-01 00:00:00", 6716),
            (1, "2000-01-01 00:00:00", 516),
            (2, "1980-06-01 00:00:00", 7716),
            (1, "1978-03-01 00:00:00", 7716),
            (1, "1974-06-01 00:00:00", 5916),
            (1, "1970-11-01 00:00:00", 6916),
            (3, "2015-02-01 00:00:00", 1116),
            (2, "1975-09-01 00:00:00", 5616),
            (4, "2000-07-01 00:00:00", 1516),
            (1, "1972-10-01 00:00:00", 5916),
            (1, "1975-12-01 00:00:00", 5116),
            (4, "2000-05-01 00:00:00", 1216),
            (1, "1977-02-01 00:00:00", 5716),
            (2, "1975-10-01 00:00:00", 5716),
            (1, "1977-02-01 00:00:00", 7716),
            (2, "1979-07-01 00:00:00", 7716),
            (30, "1957-10-01 00:00:00", 916),
            (1, "1975-06-01 00:00:00", 5716),
            (2, "1966-05-01 00:00:00", 7016),
            (1, "1969-05-01 00:00:00", 5916),
            (2, "1969-06-01 00:00:00", 6916),
            (19, "1983-12-01 00:00:00", 716),
            (1, "2000-06-01 00:00:00", 516),
            (2, "1977-02-01 00:00:00", 5616),
            (1, "1970-11-01 00:00:00", 6816),
            (23, "1989-10-01 00:00:00", 2516),
            (4, "2000-10-01 00:00:00", 816),
            (3, "2000-02-01 00:00:00", 3516),
            (5, "1975-10-01 00:00:00", 5616),
            (21, "1959-08-01 00:00:00", 416),
            (2, "1975-06-01 00:00:00", 5616),
            (3, "2006-11-01 00:00:00", 1916),
            (1, "1989-03-01 00:00:00", 2016),
            (1, "1974-07-01 00:00:00", 5316),
            (1, "1974-09-01 00:00:00", 5916),
            (1, "1974-06-01 00:00:00", 5116),
            (2, "1969-08-01 00:00:00", 7016),
            (4, "2000-12-01 00:00:00", 1516),
            (4, "2000-01-01 00:00:00", 1216),
            (1, "1973-06-01 00:00:00", 5916),
            (1, "1974-07-01 00:00:00", 7516),
            (4, "2000-12-01 00:00:00", 1016),
            (4, "2000-03-01 00:00:00", 1616),
            (1, "1969-10-01 00:00:00", 6716),
            (2, "1966-09-01 00:00:00", 7016),
            (4, "2000-04-01 00:00:00", 1716),
            (1, "1975-06-01 00:00:00", 5416),
            (2, "1971-08-01 00:00:00", 5916),
            (1, "1975-07-01 00:00:00", 5116),
            (3, "2000-03-01 00:00:00", 1816),
            (1, "1971-02-01 00:00:00", 6916),
            (1, "1974-08-01 00:00:00", 5916),
            (1, "2000-05-01 00:00:00", 516),
            (1, "1975-10-01 00:00:00", 5416),
            (16, "2006-09-01 00:00:00", 1916),
            (1, "1970-08-01 00:00:00", 7016),
            (31, "1989-08-01 00:00:00", 6516),
            (4, "2000-06-01 00:00:00", 1216),
            (4, "2000-10-01 00:00:00", 1716),
            (1, "1977-11-01 00:00:00", 7716),
            (1, "1975-09-01 00:00:00", 5416),
            (1, "1977-11-01 00:00:00", 5716),
            (1, "1969-07-01 00:00:00", 6116),
            (4, "2000-03-01 00:00:00", 1316),
            (1, "1971-02-01 00:00:00", 6816),
            (7, "1981-06-01 00:00:00", 8016),
            (2, "1977-05-01 00:00:00", 5716),
            (4, "2000-03-01 00:00:00", 1516),
            (20, "1991-05-01 00:00:00", 1416),
            (1, "1974-11-01 00:00:00", 5716),
            (1, "1977-12-01 00:00:00", 7716),
            (6, "1981-08-01 00:00:00", 8016),
            (1, "1974-04-01 00:00:00", 5116),
            (1, "1975-04-01 00:00:00", 5116),
            (1, "1974-10-01 00:00:00", 5416),
            (4, "2000-03-01 00:00:00", 1016),
            (4, "2000-12-01 00:00:00", 1616),
            (4, "2000-12-01 00:00:00", 1816),
            (2, "1979-10-01 00:00:00", 7716),
            (1, "1970-06-01 00:00:00", 7016),
            (4, "2000-05-01 00:00:00", 1716),
            (1, "2000-04-01 00:00:00", 516),
            (2, "1973-05-01 00:00:00", 7316),
            (1, "1976-08-01 00:00:00", 5116),
            (1, "1978-09-01 00:00:00", 5116),
            (2, "1973-09-01 00:00:00", 7316),
            (4, "2000-01-01 00:00:00", 816),
            (1, "1974-11-01 00:00:00", 5616),
            (2, "1977-09-01 00:00:00", 7716),
            (1, "2000-10-01 00:00:00", 516),
            (1, "1977-09-01 00:00:00", 5716),
            (2, "1974-06-01 00:00:00", 7516),
            (3, "2000-11-01 00:00:00", 3516),
            (25, "1975-07-01 00:00:00", 8216),
            (2, "1969-09-01 00:00:00", 7016),
            (1, "1970-07-01 00:00:00", 7016),
            (1, "1978-01-01 00:00:00", 6316),
            (1, "1975-07-01 00:00:00", 5316),
            (2, "1971-06-01 00:00:00", 5916),
            (4, "2000-12-01 00:00:00", 1316),
            (4, "1975-07-01 00:00:00", 7516),
            (2, "1982-08-01 00:00:00", 6016),
            (2, "1972-04-01 00:00:00", 7316),
            (4, "2000-06-01 00:00:00", 816),
            (2, "1976-08-01 00:00:00", 7716),
            (2, "1970-08-01 00:00:00", 6916),
            (2, "2000-09-01 00:00:00", 1816),
            (1, "1977-07-01 00:00:00", 5916),
            (1, "2000-05-01 00:00:00", 2016),
            (7, "1990-07-01 00:00:00", 5816),
            (2, "1973-07-01 00:00:00", 7516),
            (2, "1972-06-01 00:00:00", 1516),
            (1, "1977-08-01 00:00:00", 7816),
            (4, "2000-02-01 00:00:00", 1516),
            (2, "1970-09-01 00:00:00", 6716),
            (2, "1974-07-01 00:00:00", 5616),
            (2, "1970-08-01 00:00:00", 6816),
            (2, "1979-06-01 00:00:00", 7716),
        )
    }

    # Goofy column order, but the test data is in that order
    result_rows = {
        (
            row.count,
            row.date_trunc,
            row.history_id,
        )
        for row in q.all()
    }

    assert expected_rows <= result_rows


@pytest.mark.usefixtures("new_db_left")
def test_index(schema_name, prepared_schema_from_migrations_left):
    """Test that ObsCountPerMonthHistory has the expected index."""
    engine, script = prepared_schema_from_migrations_left
    inspector = sqlalchemy.inspect(engine)
    indexes = inspector.get_indexes(
        table_name=(ObsCountPerMonthHistory.base_name()), schema=schema_name
    )
    assert indexes == [
        {
            "name": "obs_count_per_month_history_idx",
            "column_names": [
                "date_trunc",
                "history_id",
            ],
            "unique": False,
            "include_columns": [],
            "dialect_options": {"postgresql_include": []},
        }
    ]
